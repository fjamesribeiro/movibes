{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-12 px-4">
  <div class="max-w-3xl mx-auto">

    <!-- Header -->
    <div class="text-center mb-10">
      <div class="inline-block p-3 bg-yellow-400 rounded-2xl mb-4">
        <svg class="w-8 h-8 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
      </div>
      <h1 class="text-4xl font-bold text-white mb-3">
        Complete seu Perfil
      </h1>
      <p class="text-gray-400 text-lg">
        Quase lá! Precisamos dos seus dados básicos e do seu perfil de aluno.
      </p>
    </div>

    <form method="POST" class="space-y-6" enctype="multipart/form-data">
      {% csrf_token %}

      {% if user_form.non_field_errors or profile_form.non_field_errors %}
      <div class="bg-red-900/50 backdrop-blur border border-red-700 text-red-200 px-6 py-4 rounded-xl">
        {% for error in user_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
        {% for error in profile_form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
      </div>
      {% endif %}

      <!-- Seção: Informações Pessoais -->
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">1</span>
          Informações Pessoais
        </h2>

        <!-- Foto de Perfil -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ user_form.url_foto_perfil.label }}
          </label>
          <div class="relative">
            {% render_field user_form.url_foto_perfil class="w-full p-4 bg-gray-700/50 border-2 border-dashed border-gray-600 rounded-xl text-white file:bg-yellow-400 file:border-0 file:text-gray-900 file:font-semibold file:py-2.5 file:px-5 file:rounded-lg file:cursor-pointer file:transition-all file:hover:bg-yellow-500 file:mr-4" %}
          </div>
          {% if user_form.url_foto_perfil.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in user_form.url_foto_perfil.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Nome e Sobrenome -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="{{ user_form.first_name.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              {{ user_form.first_name.label }} <span class="text-yellow-400">*</span>
            </label>
            {% render_field user_form.first_name class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: James" %}
            {% if user_form.first_name.errors %}
            <div class="text-red-400 text-sm mt-2">
              {% for error in user_form.first_name.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>

          <div>
            <label for="{{ user_form.last_name.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              {{ user_form.last_name.label }} <span class="text-yellow-400">*</span>
            </label>
            {% render_field user_form.last_name class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: Ribeiro" %}
            {% if user_form.last_name.errors %}
            <div class="text-red-400 text-sm mt-2">
              {% for error in user_form.last_name.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Bio -->
        <div class="mb-6">
          <label for="{{ user_form.bio_curta.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ user_form.bio_curta.label }}
            <span class="text-gray-500 font-normal">(max 140 caracteres)</span>
          </label>
          {% render_field user_form.bio_curta class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all resize-none" rows="3" placeholder="Fale um pouco sobre você..." %}
          {% if user_form.bio_curta.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in user_form.bio_curta.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- WhatsApp -->
        <div class="mb-6">
          <label for="{{ user_form.whatsapp.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ user_form.whatsapp.label }}
            <span class="text-gray-500 font-normal">(11 dígitos com DDD)</span>
          </label>
          {% render_field user_form.whatsapp type="tel" id="id_whatsapp" maxlength="11" pattern="[0-9]{11}" class="w-full max-w-xs p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="85999998888" %}
          <p id="whatsapp_helper" class="text-xs text-gray-500 mt-1">Exemplo: 85999998888 (DDD + 9 dígitos)</p>
          <p id="whatsapp_feedback" class="text-sm mt-2 hidden"></p>
          {% if user_form.whatsapp.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in user_form.whatsapp.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Seção: Perfil de Aluno -->
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">2</span>
          Perfil de Aluno
        </h2>

        <!-- Tipo de Conta - NOVA SEÇÃO -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.tipo_conta.label }}
            <span class="text-yellow-400">*</span>
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.tipo_conta %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-gradient-to-r peer-checked:from-yellow-400 peer-checked:to-yellow-500 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-5 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center justify-between group">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-gray-600 group-[.peer-checked]:bg-gray-900 flex items-center justify-center mr-4 transition-all">
                    <svg class="w-5 h-5 text-gray-400 group-[.peer-checked]:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </div>
                  <span class="text-base">{{ radio.choice_label }}</span>
                </div>
                <svg class="w-6 h-6 text-gray-500 group-[.peer-checked]:text-gray-900 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.tipo_conta.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.tipo_conta.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}

          <!-- Informação adicional sobre tipos de conta -->
          <div class="mt-4 bg-blue-900/20 border border-blue-700/50 rounded-lg p-4">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-blue-400 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div class="text-sm text-gray-300">
                <p class="font-semibold text-blue-300 mb-1">Sobre os tipos de conta:</p>
                <p class="text-gray-400">Você pode escolher seu tipo de conta agora. Contas gratuitas têm acesso aos recursos básicos, enquanto contas premium oferecem funcionalidades exclusivas.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Sexo -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.sexo.label }}
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            {% for radio in profile_form.sexo %}
            <label class="relative cursor-pointer">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 border-2 border-gray-600 bg-gray-700/50 rounded-xl p-3.5 text-gray-300 font-medium transition-all hover:border-gray-500 text-sm">
                {{ radio.choice_label }}
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.sexo.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.sexo.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Nível de Prática -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.nivel_pratica.label }}
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.nivel_pratica %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center">
                <span class="peer-checked:scale-110 transition-transform">{{ radio.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.nivel_pratica.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.nivel_pratica.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Períodos Preferidos -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.periodos_preferidos.label }}
          </label>
          <div class="space-y-3">
            {% for checkbox in profile_form.periodos_preferidos %}
            <label class="checkbox-container relative cursor-pointer block">
              {{ checkbox.tag }}
              <div class="checkbox-visual border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center">
                <div class="checkbox-icon w-6 h-6 rounded border-2 border-gray-500 bg-transparent flex items-center justify-center mr-3 transition-all">
                  <svg class="w-4 h-4 text-white opacity-0 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span>{{ checkbox.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.periodos_preferidos.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.periodos_preferidos.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Modalidades Praticadas -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.modalidades_praticadas.label }}
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for checkbox in profile_form.modalidades_praticadas %}
            <label class="checkbox-container relative cursor-pointer">
              {{ checkbox.tag }}
              <div class="checkbox-visual border-2 border-gray-600 bg-gray-700/50 rounded-xl p-3.5 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center text-sm">
                <div class="checkbox-icon w-5 h-5 rounded border-2 border-gray-500 bg-transparent flex items-center justify-center mr-2.5 transition-all flex-shrink-0">
                  <svg class="w-3.5 h-3.5 text-white opacity-0 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span>{{ checkbox.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.modalidades_praticadas.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.modalidades_praticadas.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Vibe After -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.vibe_after.label }}
            <span class="text-gray-500 font-normal text-xs">(opcional)</span>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for checkbox in profile_form.vibe_after %}
            <label class="checkbox-container relative cursor-pointer">
              {{ checkbox.tag }}
              <div class="checkbox-visual border-2 border-gray-600 bg-gray-700/50 rounded-xl p-3.5 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center text-sm">
                <div class="checkbox-icon w-5 h-5 rounded border-2 border-gray-500 bg-transparent flex items-center justify-center mr-2.5 transition-all flex-shrink-0">
                  <svg class="w-3.5 h-3.5 text-white opacity-0 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                  </svg>
                </div>
                <span>{{ checkbox.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
          {% if profile_form.vibe_after.errors %}
          <div class="text-red-400 text-sm mt-2">
            {% for error in profile_form.vibe_after.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Seção: Localização -->
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">3</span>
          Localização
        </h2>

        <div class="mb-6">
          <label for="cep_input" class="block text-sm font-semibold text-gray-300 mb-2">
            CEP
          </label>
          <input type="text" id="cep_input" maxlength="8" pattern="[0-9]{8}" class="w-full max-w-xs p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="60000000">
          <p class="text-xs text-gray-500 mt-1">Digite o CEP para preencher automaticamente</p>
          <span id="cep_status" class="text-sm text-gray-400 mt-2"></span>
        </div>

        <hr class="border-gray-700 my-6">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="{{ profile_form.estado.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Estado
            </label>
            {% render_field profile_form.estado id=profile_form.estado.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: CE" %}
          </div>
          <div>
            <label for="{{ profile_form.cidade.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Cidade
            </label>
            {% render_field profile_form.cidade id=profile_form.cidade.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: Fortaleza" %}
          </div>
          <div>
            <label for="{{ profile_form.bairro.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Bairro
            </label>
            {% render_field profile_form.bairro id=profile_form.bairro.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: Meireles" %}
          </div>
        </div>
      </div>

      <!-- Botão de Submit -->
      <button type="submit" class="w-full cursor-pointer bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-bold px-6 py-4 rounded-xl text-lg hover:from-yellow-500 hover:to-yellow-600 transform hover:scale-[1.02] transition-all shadow-lg hover:shadow-xl">
        Salvar e Continuar →
      </button>
    </form>
  </div>
</div>

<style>
  /* Esconde os radio buttons e checkboxes padrão */
  input[type="radio"],
  input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* Animação suave para as transições */
  * {
    transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 200ms;
  }

  /* Estados dos checkboxes customizados */
  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual {
    background-color: rgb(250 204 21);
    border-color: rgb(250 204 21);
    color: rgb(17 24 39);
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  }

  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual .checkbox-icon {
    background-color: rgb(17 24 39);
    border-color: rgb(17 24 39);
  }

  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual .checkbox-icon svg {
    opacity: 1;
  }

  /* Estilos específicos para tipo de conta */
  input[type="radio"]:checked ~ div {
    background: linear-gradient(to right, rgb(250 204 21), rgb(234 179 8));
    border-color: rgb(250 204 21);
    color: rgb(17 24 39);
  }
</style>

<script>
  // Busca CEP usando ViaCEP
  const cepInput = document.getElementById('cep_input');
  const statusSpan = document.getElementById('cep_status');

  if (cepInput) {
    cepInput.addEventListener('input', function() {
      const cleanedCep = this.value.replace(/\D/g, '');

      if (cleanedCep.length !== 8) {
        statusSpan.textContent = '';
        return;
      }

      statusSpan.textContent = 'Buscando CEP...';
      statusSpan.className = 'text-sm text-gray-400 mt-2 block';

      fetch(`https://viacep.com.br/ws/${cleanedCep}/json/`)
        .then(res => res.json())
        .then(data => {
          if (data.erro) {
            statusSpan.textContent = 'CEP não encontrado.';
            statusSpan.className = 'text-sm text-red-400 mt-2 block';
          } else {
            document.getElementById('{{ profile_form.estado.id_for_label }}').value = data.uf;
            document.getElementById('{{ profile_form.cidade.id_for_label }}').value = data.localidade;
            document.getElementById('{{ profile_form.bairro.id_for_label }}').value = data.bairro;
            statusSpan.textContent = 'Endereço preenchido!';
            statusSpan.className = 'text-sm text-green-400 mt-2 block';
          }
        })
        .catch(err => {
          statusSpan.textContent = 'Erro ao buscar o CEP.';
          statusSpan.className = 'text-sm text-red-400 mt-2 block';
        });
    });
  }

  // Validação do WhatsApp - aceita apenas números e valida ao sair do campo
  const whatsappInput = document.getElementById('id_whatsapp');
  const whatsappFeedback = document.getElementById('whatsapp_feedback');
  const whatsappHelper = document.getElementById('whatsapp_helper');

  if (whatsappInput) {
    // Durante a digitação: limpa caracteres não numéricos
    whatsappInput.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
      if (this.value.length > 11) {
        this.value = this.value.slice(0, 11);
      }
      whatsappFeedback.classList.add('hidden');
      whatsappHelper.classList.remove('hidden');
      this.classList.remove('border-red-500', 'border-green-500');
      this.classList.add('border-gray-600');
    });

    // Ao sair do campo: valida e mostra feedback
    whatsappInput.addEventListener('blur', function() {
      const value = this.value.trim();
      const regexCelular = /^[1-9]{2}9[0-9]{8}$/;

      // Se o campo estiver vazio, não mostra erro (assume que é opcional)
      if (value === '') {
        whatsappFeedback.classList.add('hidden');
        whatsappHelper.classList.remove('hidden');
        this.classList.remove('border-red-500', 'border-green-500');
        this.classList.add('border-gray-600');
        return;
      }

      // Valida se não bate com o regex
      if (!regexCelular.test(value)) {
        // Mostra mensagem de erro
        whatsappFeedback.textContent = `❌ WhatsApp inválido. Deve ter 11 dígitos (DDD + 9xxxxxxxx).`;
        whatsappFeedback.className = 'text-sm mt-2 text-red-400 block';
        whatsappHelper.classList.add('hidden');
        this.classList.remove('border-gray-600', 'border-green-500');
        this.classList.add('border-red-500');
      } else {
        whatsappFeedback.classList.add('hidden');
        whatsappHelper.classList.remove('hidden');
        this.classList.remove('border-red-500', 'border-green-500');
        this.classList.add('border-gray-600');
      }
    });

    // Ao focar no campo novamente: remove o feedback de sucesso/erro
    whatsappInput.addEventListener('focus', function() {
      whatsappFeedback.classList.add('hidden');
      whatsappHelper.classList.remove('hidden');
    });
  }
</script>
{% endblock %}
