{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-12 px-4">
  <div class="max-w-3xl mx-auto">

    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-white mb-3">
        Meu Perfil
      </h1>
      <p class="text-gray-400 text-lg">
        Veja e edite suas informações.
      </p>
    </div>

    <!-- Card de Status da Assinatura (se existir) -->
    {% if user.tem_assinatura_ativa %}
    <div class="mb-6 bg-gradient-to-r from-yellow-900/30 to-yellow-800/30 backdrop-blur border-2 border-yellow-500/50 rounded-2xl p-6 shadow-xl">
      <div class="flex items-start justify-between">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-yellow-400 rounded-xl flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
              </svg>
            </div>
          </div>
          <div class="flex-1">
            {% if user.eh_premium %}
            <h3 class="text-xl font-bold text-yellow-400 mb-1">
              Conta Premium Ativa
            </h3>
            <p class="text-gray-300 text-sm mb-2">
              Você tem acesso a todos os recursos exclusivos para alunos premium.
            </p>
            {% elif user.eh_profissional_ativo %}
            <h3 class="text-xl font-bold text-yellow-400 mb-1">
              Conta Profissional Ativa
            </h3>
            <p class="text-gray-300 text-sm mb-2">
              Sua assinatura profissional está ativa e você pode usar todas as funcionalidades.
            </p>
            {% endif %}
            {% with assinatura=user.obter_assinatura_ativa %}
            <div class="flex items-center gap-4 text-xs text-gray-400">
              <span>Plano: <strong class="text-yellow-300">{{ assinatura.tipo_plano.nome }}</strong></span>
              <span>•</span>
              <span>Expira em: <strong class="text-yellow-300">{{ assinatura.data_expiracao|date:"d/m/Y" }}</strong></span>
              <span>•</span>
              <span><strong class="text-yellow-300">{{ assinatura.dias_restantes }}</strong> dias restantes</span>
            </div>
            {% endwith %}
          </div>
        </div>
        <a href="{% url 'historico_assinaturas' %}" class="px-4 py-2 bg-yellow-400/20 hover:bg-yellow-400/30 border border-yellow-400/50 rounded-lg text-yellow-400 text-sm font-semibold transition-all">
          Ver Histórico
        </a>
      </div>
    </div>
    {% endif %}

    <form method="POST" class="space-y-6" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Seção: Informações Pessoais -->
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">1</span>
          Informações Pessoais
        </h2>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ user_form.url_foto_perfil.label }}
          </label>
          {% if user.url_foto_perfil %}
          <div class="flex items-center space-x-4 mb-4">
            <img src="{{ user.url_foto_perfil.url }}" alt="Foto atual" class="w-24 h-24 rounded-full object-cover border-4 border-gray-600">
            <span class="text-gray-400 text-sm">Para alterar, envie uma nova foto abaixo:</span>
          </div>
          {% endif %}
          <div class="relative">
            {% render_field user_form.url_foto_perfil class="w-full p-4 bg-gray-700/50 border-2 border-dashed border-gray-600 rounded-xl text-white file:bg-yellow-400 file:border-0 file:text-gray-900 file:font-semibold file:py-2.5 file:px-5 file:rounded-lg file:cursor-pointer file:transition-all file:hover:bg-yellow-500 file:mr-4" %}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="{{ user_form.first_name.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              {{ user_form.first_name.label }} <span class="text-yellow-400">*</span>
            </label>
            {% render_field user_form.first_name class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" %}
          </div>
          <div>
            <label for="{{ user_form.last_name.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              {{ user_form.last_name.label }} <span class="text-yellow-400">*</span>
            </label>
            {% render_field user_form.last_name class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" %}
          </div>
        </div>

        <div class="mb-6">
          <label for="{{ user_form.bio_curta.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ user_form.bio_curta.label }}
          </label>
          {% render_field user_form.bio_curta class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all resize-none" rows="3" %}
        </div>

        <div class="mb-6">
          <label for="{{ user_form.whatsapp.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ user_form.whatsapp.label }}
            <span class="text-gray-500 font-normal">(11 dígitos com DDD)</span>
          </label>
          {% render_field user_form.whatsapp type="tel" id="id_whatsapp" maxlength="11" pattern="[0-9]{11}" class="w-full max-w-xs p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" %}
          <p id="whatsapp_helper" class="text-xs text-gray-500 mt-1">Exemplo: 85999998888 (DDD + 9 dígitos)</p>
          <p id="whatsapp_feedback" class="text-sm mt-2 hidden"></p>
        </div>
      </div>

      <!-- Card de Galeria -->
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl text-center">
          <h2 class="text-2xl font-bold text-white mb-4">Minha Galeria</h2>
          <p class="text-gray-400 mb-6">Adicione e gerencie as fotos que aparecem no seu perfil.</p>
          <a href="{% url 'account_galeria' %}"
             class="inline-block cursor-pointer bg-yellow-400 text-gray-900 font-bold px-6 py-3 rounded-xl text-base hover:bg-yellow-500 transform hover:scale-[1.02] transition-all shadow-lg">
              Gerenciar Galeria
          </a>
      </div>

      <!-- Seção: Perfil de Aluno -->
      {% if profile_type == 'aluno' %}
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">2</span>
          Perfil de Aluno
        </h2>

        <!-- CAMPO TIPO DE CONTA - NOVO! -->
        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.tipo_conta.label }}
            <span class="text-yellow-400">*</span>
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.tipo_conta %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-gradient-to-r peer-checked:from-yellow-400 peer-checked:to-yellow-500 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-5 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center justify-between group">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-gray-600 group-[.peer-checked]:bg-gray-900 flex items-center justify-center mr-4 transition-all">
                    <svg class="w-5 h-5 text-gray-400 group-[.peer-checked]:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                  </div>
                  <span class="text-base">{{ radio.choice_label }}</span>
                </div>
                <svg class="w-6 h-6 text-gray-500 group-[.peer-checked]:text-gray-900 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </label>
            {% endfor %}
          </div>

          <!-- Botão para Upgrade se for Free -->
          {% if user.aluno.tipo_conta.nome == "Free" %}
          <div class="mt-4 bg-blue-900/20 border border-blue-700/50 rounded-lg p-4">
            <div class="flex items-start justify-between">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                  <p class="text-sm text-gray-300 mb-2">Quer aproveitar todos os recursos da plataforma? Faça upgrade para Premium!</p>
                  <a href="{% url 'escolher_plano' %}" class="inline-block text-sm font-semibold text-blue-400 hover:text-blue-300 transition-colors">
                    Ver planos Premium →
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.sexo.label }}
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            {% for radio in profile_form.sexo %}
            <label class="relative cursor-pointer">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 border-2 border-gray-600 bg-gray-700/50 rounded-xl p-3.5 text-center text-gray-300 font-medium transition-all hover:border-gray-500 text-sm">
                {{ radio.choice_label }}
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.nivel_pratica.label }}
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.nivel_pratica %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center">
                <span class="peer-checked:scale-110 transition-transform">{{ radio.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.periodos_preferidos.label }}
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.periodos_preferidos %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500">
                {{ radio.choice_label }}
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.vibe_after.label }}
            <span class="text-gray-500 font-normal text-xs ml-2">(Selecione todas que se aplicam)</span>
          </label>
          <div class="space-y-3">
            {% for checkbox in profile_form.vibe_after %}
            <label class="relative cursor-pointer block checkbox-container">
              {{ checkbox.tag }}
              <div class="checkbox-visual border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center">
                <span class="checkbox-icon flex items-center justify-center w-6 h-6 border-2 border-gray-500 rounded bg-gray-600 mr-3 transition-all">
                  <svg class="w-4 h-4 text-yellow-400 opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </span>
                <span class="flex-1">{{ checkbox.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.preferencias_esporte.label }}
            <span class="text-gray-500 font-normal text-xs ml-2">(Selecione todas que se aplicam)</span>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for checkbox in profile_form.preferencias_esporte %}
            <label class="relative cursor-pointer checkbox-container">
              {{ checkbox.tag }}
              <div class="checkbox-visual border-2 border-gray-600 bg-gray-700/50 rounded-xl p-3.5 text-gray-300 font-medium transition-all hover:border-gray-500 flex items-center text-sm">
                <span class="checkbox-icon flex items-center justify-center w-5 h-5 border-2 border-gray-500 rounded bg-gray-600 mr-2.5 transition-all flex-shrink-0">
                  <svg class="w-3.5 h-3.5 text-yellow-400 opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </span>
                <span>{{ checkbox.choice_label }}</span>
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-sm font-semibold text-gray-300 mb-3">
            {{ profile_form.status_social.label }}
          </label>
          <div class="space-y-3">
            {% for radio in profile_form.status_social %}
            <label class="relative cursor-pointer block">
              {{ radio.tag }}
              <div class="peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-gray-900 peer-checked:shadow-lg border-2 border-gray-600 bg-gray-700/50 rounded-xl p-4 text-gray-300 font-medium transition-all hover:border-gray-500">
                {{ radio.choice_label }}
              </div>
            </label>
            {% endfor %}
          </div>
        </div>

        <h3 class="text-xl font-bold text-white mb-4 mt-8">Localização</h3>

        <div class="mb-6">
          <label for="cep_input" class="block text-sm font-semibold text-gray-300 mb-2">
            CEP <span class="text-gray-500 font-normal">(para auto-preenchimento)</span>
          </label>
          <input
            type="text"
            id="cep_input"
            placeholder="Digite os 8 números do CEP"
            maxlength="8"
            class="w-full max-w-xs p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all"
          >
          <span id="cep_status" class="text-sm text-gray-400 mt-2 block"></span>
        </div>

        <hr class="border-gray-700 my-6">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="{{ profile_form.estado.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Estado
            </label>
            {% render_field profile_form.estado id=profile_form.estado.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: CE" %}
          </div>
          <div>
            <label for="{{ profile_form.cidade.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Cidade
            </label>
            {% render_field profile_form.cidade id=profile_form.cidade.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: Fortaleza" %}
          </div>
          <div>
            <label for="{{ profile_form.bairro.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
              Bairro
            </label>
            {% render_field profile_form.bairro id=profile_form.bairro.id_for_label class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: Meireles" %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Seção: Perfil de Profissional - NOVO! -->
      {% if profile_type == 'profissional' %}
      <div class="bg-gray-800/50 backdrop-blur border border-gray-700 rounded-2xl p-8 shadow-xl">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
          <span class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center text-gray-900 font-bold mr-3">2</span>
          Perfil Profissional
        </h2>

        <div class="mb-6">
          <label for="{{ profile_form.especialidade.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ profile_form.especialidade.label }}
            <span class="text-yellow-400">*</span>
          </label>
          {% render_field profile_form.especialidade class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all resize-none" rows="4" placeholder="Ex: Personal Trainer, Professor de Yoga, Nutricionista Esportivo..." %}
          <p class="text-xs text-gray-500 mt-1">Descreva suas áreas de atuação e especialização</p>
        </div>

        <div class="mb-6">
          <label for="{{ profile_form.num_conselho_classe.id_for_label }}" class="block text-sm font-semibold text-gray-300 mb-2">
            {{ profile_form.num_conselho_classe.label }}
            <span class="text-gray-500 font-normal">(opcional)</span>
          </label>
          {% render_field profile_form.num_conselho_classe class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-transparent transition-all" placeholder="Ex: CREF 123456-G/CE" %}
          <p class="text-xs text-gray-500 mt-1">CREF, CRN, ou outro registro profissional</p>
        </div>

        <!-- Informação sobre Assinatura Profissional -->
        {% if not user.tem_assinatura_ativa %}
        <div class="mt-6 bg-red-900/20 border border-red-700/50 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
              <p class="text-sm font-semibold text-red-300 mb-2">Assinatura Necessária</p>
              <p class="text-sm text-gray-300 mb-3">Sua conta profissional precisa de uma assinatura ativa para acessar todas as funcionalidades da plataforma.</p>
              <a href="{% url 'escolher_plano' %}" class="inline-block px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors text-sm">
                Escolher Plano Profissional
              </a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <button type="submit" class="w-full cursor-pointer bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 font-bold px-6 py-4 rounded-xl text-lg hover:from-yellow-500 hover:to-yellow-600 transform hover:scale-[1.02] transition-all shadow-lg hover:shadow-xl">
        Salvar Alterações
      </button>
    </form>
  </div>
</div>

<style>
  /* Esconde os radio buttons e checkboxes padrão */
  input[type="radio"],
  input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  /* Animação suave para as transições */
  * {
    transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 200ms;
  }

  /* Estados dos checkboxes customizados */
  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual {
    background-color: rgb(250 204 21);
    border-color: rgb(250 204 21);
    color: rgb(17 24 39);
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  }

  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual .checkbox-icon {
    background-color: rgb(17 24 39);
    border-color: rgb(17 24 39);
  }

  .checkbox-container input[type="checkbox"]:checked ~ .checkbox-visual .checkbox-icon svg {
    opacity: 1;
  }
</style>

<script>
  // Busca CEP usando ViaCEP
  const cepInput = document.getElementById('cep_input');
  const statusSpan = document.getElementById('cep_status');

  if (cepInput) {
    cepInput.addEventListener('input', function() {
      const cleanedCep = this.value.replace(/\D/g, '');

      if (cleanedCep.length !== 8) {
        statusSpan.textContent = '';
        return;
      }

      statusSpan.textContent = 'Buscando CEP...';
      statusSpan.className = 'text-sm text-gray-400 mt-2 block';

      fetch(`https://viacep.com.br/ws/${cleanedCep}/json/`)
        .then(res => res.json())
        .then(data => {
          if (data.erro) {
            statusSpan.textContent = 'CEP não encontrado.';
            statusSpan.className = 'text-sm text-red-400 mt-2 block';
          } else {
            document.getElementById('{{ profile_form.estado.id_for_label }}').value = data.uf;
            document.getElementById('{{ profile_form.cidade.id_for_label }}').value = data.localidade;
            document.getElementById('{{ profile_form.bairro.id_for_label }}').value = data.bairro;
            statusSpan.textContent = 'Endereço preenchido!';
            statusSpan.className = 'text-sm text-green-400 mt-2 block';
          }
        })
        .catch(err => {
          statusSpan.textContent = 'Erro ao buscar o CEP.';
          statusSpan.className = 'text-sm text-red-400 mt-2 block';
        });
    });
  }

  // Validação do WhatsApp
  const whatsappInput = document.getElementById('id_whatsapp');
  const whatsappFeedback = document.getElementById('whatsapp_feedback');
  const whatsappHelper = document.getElementById('whatsapp_helper');

  if (whatsappInput) {
    whatsappInput.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
      if (this.value.length > 11) {
        this.value = this.value.slice(0, 11);
      }
      whatsappFeedback.classList.add('hidden');
      whatsappHelper.classList.remove('hidden');
      this.classList.remove('border-red-500', 'border-green-500');
      this.classList.add('border-gray-600');
    });

    whatsappInput.addEventListener('blur', function() {
      const value = this.value.trim();
      const regexCelular = /^[1-9]{2}9[0-9]{8}$/;

      if (value === '') {
        whatsappFeedback.classList.add('hidden');
        whatsappHelper.classList.remove('hidden');
        this.classList.remove('border-red-500', 'border-green-500');
        this.classList.add('border-gray-600');
        return;
      }

      if (!regexCelular.test(value)) {
        whatsappFeedback.textContent = `❌ WhatsApp inválido. Deve ter 11 dígitos (DDD + 9xxxxxxxx).`;
        whatsappFeedback.className = 'text-sm mt-2 text-red-400 block';
        whatsappHelper.classList.add('hidden');
        this.classList.remove('border-gray-600', 'border-green-500');
        this.classList.add('border-red-500');
      } else {
        whatsappFeedback.classList.add('hidden');
        whatsappHelper.classList.remove('hidden');
        this.classList.remove('border-red-500', 'border-green-500');
        this.classList.add('border-gray-600');
      }
    });

    whatsappInput.addEventListener('focus', function() {
      whatsappFeedback.classList.add('hidden');
      whatsappHelper.classList.remove('hidden');
    });
  }
</script>
{% endblock %}
